#!/usr/bin/env ruby
# -*- coding: utf-8 -*-

$LOAD_PATH.unshift File.expand_path('../../lib', __FILE__)

require 'rubygems'
require 'bundler/setup'
require 'vnet/api_rpc'

# Start the switch manager before any celluloid services in order to
# avoid cloned file descriptors to e.g. zmq remaining open.
Vnet::Openflow::SwitchManager.new.tap { |sm|
  sm.configure_trema
  sm.cleanup_current_session
  sm.kill_old_switches
  sm.start
}

require 'dcell'
require 'dcell/registries/redis_adapter'
require 'ext/celluloid'

controller = Vnet::Openflow::Controller.new.tap { |controller|
  controller.init_trema
  controller.open_trema_tasks
  controller.trema_thread = Thread.current
}

#Vnet::Initializers::Logger.run("vna.log")

conf = Vnet::Configurations::Vna.conf

Vnet::NodeApi.raise_on_error = false # dont raise any errors

DCell.start(Vnet::Configurations::Vna.dcell_params)
Celluloid.start

trap 'TTIN' do
  Celluloid.stack_dump
end

Vnet::NodeModules::ServiceOpenflow.supervise_as :service_openflow
Celluloid::Actor[:service_openflow].set_controller(controller)

Celluloid.logger.debug "starting trema controller on thread #{Thread.current.inspect}"
controller.run_no_init!
