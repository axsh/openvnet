#!/usr/bin/env ruby
# -*- coding: utf-8 -*-

$LOAD_PATH.unshift File.expand_path('../../lib', __FILE__)

require 'rubygems'
require 'bundler/setup'
require 'vnet'

#Vnet::Initializers::Logger.run("vna.log")

conf = Vnet::Configurations::Vna.conf

# Start the switch manager before any celluloid services in order to
# avoid cloned file descriptors to e.g. zmq remaining open.
switch_manager_new = Vnet::NodeModules::SwitchManager.new
switch_manager_new.configure_trema
switch_manager_new.cleanup_current_session
switch_manager_new.kill_old_switches
switch_manager_new.start

Vnet::NodeApi.set_proxy(conf.node_api_proxy)
Vnet::NodeApi.raise_on_error = false # dont raise any errors

case conf.node_api_proxy
when :rpc
  # do nothing
when :direct
  Vnet::Initializers::DB.run(conf.db_uri)
end

Celluloid.start

trap 'TTIN' do
  Celluloid.stack_dump
end

DCell.start(Vnet::Configurations::Vna.dcell_params)

Vnet::NodeModules::ServiceOpenflow.supervise_as :service_openflow

Celluloid::Actor[:service_openflow].prepare_controller(Thread.current).tap { |controller|
  Celluloid.logger.debug "starting trema controller on thread #{Thread.current.inspect}"
  controller.run_no_init!
}
