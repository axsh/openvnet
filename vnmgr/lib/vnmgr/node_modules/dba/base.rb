# -*- coding: utf-8 -*-

require 'sequel'

module Vnmgr::NodeModules::DBA
  class Base

    include Celluloid
    include Celluloid::Logger

    task_class TaskThread

    def initialize
      @@models ||= Module.const_get('Vnmgr').const_get('Models')
      info "#{self.class.to_s} initialized.."
    end

    private
    def taggable_find(uuid)
      model = @@models::Taggable.find(uuid)
    end

    def class_name
      self.class.to_s.split('::').last
    end

    #TODO
    # cleanup model search
    #
    def model_find
      @@models.const_get(class_name)
    end

    public
    def entry(method_name, args)
      if args.nil?
        self.method(method_name).call
      else
        self.method(method_name).call(args)
      end
    rescue StandardError => e
      abort e
    end

    def create(params)
      model = model_find
      info "[create]: model = #{model}, params = #{params}"
      record = model.new(params)
      record.save_changes
      record.to_hash
    end

    def get_all
      debug "get_all invoked"
      model = model_find
      info "[get_all]: model = #{model}"
      records = model.all
      records.map { |record|
        record.to_hash
      }
    end

    def get(uuid)
      info "[get]: uuid = #{uuid}"
      record = taggable_find(uuid)
      record.to_hash
    end

    def update(params)
      info "[update]: params = #{params}"
      record = taggable_find(params['uuid'])
      record.update(params)
      info "[update] updated (uuid:#{params['uuid']})"
      record.to_hash
    end

    def delete(uuid)
      info "[delete]: uuid = #{uuid}"
      record = taggable_find(uuid)
      record.delete
      info "[delete]: record deleted (uuid:#{uuid})"
      nil
    end
  end
end
