# -*- coding: utf-8 -*-

require 'sequel'

module Vnmgr::NodeModules
  class Dba
    include Celluloid
    include Celluloid::Logger

    task_class TaskThread

    def initialize(*args, &block)
      info "Dba initalized."
      @model_classes = {}
    end

    def execute(class_name, method_name, *args)
      begin
        unless @model_classes[class_name]
          @model_classes[class_name] = Vnmgr::Models.const_get(class_name.to_s.classify)
        end

        # TODO db transaction
        ret = @model_classes[class_name].send(method_name, *args)
        case ret
        when Array
          ret.map(&:to_hash)
        when nil
          nil
        else
          # should respond to to_hash
          ret.to_hash
        end
      rescue => e
        error(e)
        abort(e)
      end
    end
  end
end
