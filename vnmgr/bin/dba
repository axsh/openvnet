#!/usr/bin/env ruby
# -*- coding: utf-8 -*-

$LOAD_PATH.unshift File.expand_path('../../lib', __FILE__)

require 'rubygems'
require 'dcell'
require 'vnmgr'

path = ['/etc/wakame-vnet/dba.conf'].find { |i| File.exists?(i) }

conf = Vnmgr::Configurations::Dba.load(path).config
Vnmgr::Initializers::DB.run(conf[:db_uri])

DCell.start :id => conf[:cluster_name], :addr => "tcp://#{conf[:db_agent_ip]}:#{conf[:db_agent_port]}",
  :registry => {
    :adapter => 'redis',
    :host => conf[:redis_host],
    :port => conf[:redis_port]
  }

# Vnmgr::NodeModules::DbAgent.supervise_as conf[:node_name]
Vnmgr::NodeModules::DBA::Network.supervise_as :network
Vnmgr::NodeModules::DBA::Vif.supervise_as :vif
sleep
