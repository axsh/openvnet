#!/usr/bin/env ruby
# -*- coding: utf-8 -*-

$LOAD_PATH.unshift File.expand_path('../../lib', __FILE__)

require 'rubygems'
require 'dcell'
require 'vnmgr'

conf = Vnmgr::Configurations::Dba.load('/etc/wakame-vnet/dba.conf').config
Vnmgr::Initializers::DB.run(conf[:db_uri])

DCell.start :id => conf[:cluster_name], :addr => "tcp://#{conf[:db_agent_ip]}:#{conf[:db_agent_port]}",
  :registry => {
    :adapter => 'redis',
    :host => conf[:redis_host],
    :port => conf[:redis_port]
  }

#TODO: port the following array of symbols to config file.
[:network, :vif, :dhcp_range, :mac_range, :router, :tunnel, :dc_network, :datapath, :open_flow_controller, :ip_address, :ip_lease].each do |s|
  klass = s.to_s.split('_').map {|w| w.capitalize }.join('')
  Module.const_get('Vnmgr').const_get('NodeModules').const_get('DBA').const_get(klass).supervise_as s
end
sleep
