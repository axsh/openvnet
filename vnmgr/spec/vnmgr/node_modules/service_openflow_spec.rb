# -*- coding: utf-8 -*-
require 'spec_helper'

describe Vnmgr::NodeModules::ServiceOpenflow do
  
  describe "create_tunnel" do
    before(:each) do
      (1..3).each { |i| Fabricate("datapath_#{i}") }
    end
  
    it "should create the entries in the tunnel table" do
      ofctl = double(:ofctl)
      Vnmgr::VNet::Openflow::OvsOfctl.stub(:new).and_return(ofctl)
      ofctl.should_receive(:add_gre_tunnel).with(/^t-/,"192.168.2.2")
      
      so = Vnmgr::NodeModules::ServiceOpenflow.new
      conf = Vnmgr::Configurations::Vna.conf
      so.create_tunnels
      tunnels = Vnmgr::Models::Datapath.find({:node_id => conf.node.id}).tunnels
      expect(tunnels.size).to eq 1
      expect(tunnels.first.dst_datapath.node_id).to eq "vna3"
      expect(tunnels.first.dst_datapath.dc_segment_id).to eq "2"
    end
  end
end
